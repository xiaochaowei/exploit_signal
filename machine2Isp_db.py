import os
import scipy.io as sio
import numpy as np 
import psycopg2
def aggerate(signal):
	return signal.mean(0)
def main():
	filename = os.sys.argv[1]
	d = sio.loadmat(filename)
	machine_list = d['machine_ids']
	signals = d['signal']
	(length, dim) = signals.shape
	macine_list_len = machine_list.shape[1]
	conn = psycopg2.connect(user = 'patch', port = '5433')
	cursor = conn.cursor()
	isp2signal = {}
	for idx, machine_id  in enumerate(machine_list[0]):
		if idx % 100 == 0:
			print """process : {0}/{1} """.format(idx, length)
		cursor.execute("""SELECT isp FROM machine_isp where machine_id = {0};  """.format(machine_id))	
		for isp in cursor.fetchall():
			#print isp[0]
			if not isp2signal.has_key(isp[0]):
				isp2signal[isp[0]] = []
			isp2signal[isp[0]].append(signals[idx])
	print "start aggerate"
	for key, signals in isp2signal.items():
		signal = aggerate(np.array(signals))
		isp2signal[key]= signal
	print "aggerate finished"
	with  open(os.sys.argv[2],'r') as fid:#read isp file
		isp_list = fid.read().split('\n')[0:-1]
	signals = []
	for isp in isp_list:
		isp = isp.replace("''", "'")
		if isp2signal.has_key(isp):
			signals.append(isp2signal[isp])
		else:
			signals.append(np.zeros(dim))
	sio.savemat(os.sys.argv[3], {'signals': signals,'isp': isp_list })

main()
