import os
import scipy.io as sio
import numpy as np 
import psycopg2
def aggerate(signal):
	return signal.mean(0)
def fastrun():
	#filename = os.sys.argv[1]
	d = sio.loadmat(filename)
	machine_list = d['machine_ids']
	signals = d['signal']
	(length, dim) = signals.shape

	machineList2isp = {}
	for row in open('machine_id2isp.csv', 'r').read().strip().split('\n'):
		machineList2isp[int(row.split('@@')[0])] = row.split('@@')[1].split('@:')
	isp2signal = {}
	machine2isp = {}
	print "load database finished!"
	count = 0
	for idx, machine_id in enumerate(machine_list[0]):
		if not machineList2isp.has_key(machine_id):
			count += 1 
			continue	
		isps = machineList2isp[machine_id]
		for isp in isps:
			#print isp
			if not isp2signal.has_key(isp):
				isp2signal[isp] = []
			isp2signal[isp].append(signals[idx])
	print """{0}/{1}""".format(count, length)
	print "match patching_data finished!"
	print "start aggerate"
	for key, signals in isp2signal.items():
		signal = aggerate(np.array(signals))
		isp2signal[key]= signal
	print "aggerate finished"
	with  open('distinct_isp.csv','r') as fid:#read isp file
		isp_list = fid.read().strip().split('\n')
	signals = []
	count = 0
	for isp in isp_list:
		isp = isp.replace("''", "'")
		if isp2signal.has_key(isp):
			signals.append(isp2signal[isp])
		else:
		#	print isp
			count += 1
			signals.append(np.zeros(dim))
	print "miss data" , count
	sio.savemat(os.sys.argv[2], {'signals': signals,'isp': isp_list })
def main():
	d = sio.loadmat('random2_2013_all.mat')
#	products = ['chrome','firefox','flashplayer','thunderbird']
	products = ['chrome', 'firefox', 'thunderbird']
	machineList2isp = {}#machine 2 group of isp 
	with open("machine_isp_filter", 'r') as fid:
		rows = fid.read().strip().split('\n')
	for row in rows:
		if row == "":
			continue
		tmp = row.split(',')
		if not machineList2isp.has_key(int(tmp[0])):	
			machineList2isp[int(tmp[0])] = set()
		machineList2isp[int(tmp[0])].add(tmp[2])
	print "load database finished!"
	for product in products:
		machine_list = d[product]['machine_ids'][0][0][0]
		signals = d[product]['signal'][0][0]		
		(length, dim) = signals.shape
		isp2signal = {}
		machine2isp = {}
		count = 0
		for idx, machine_id in enumerate(machine_list):
			if not machineList2isp.has_key(machine_id):
				count += 1 
				continue	
			isps = machineList2isp[machine_id]
			for isp in isps:
				#print isp
				if not isp2signal.has_key(isp):
					isp2signal[isp] = []
				isp2signal[isp].append(signals[idx])
		print """{0}/{1}""".format(count, length)
		print "match patching_data finished!"

		print "start aggerate"
		for key, signals in isp2signal.items():
			signal = aggerate(np.array(signals))
			isp2signal[key]= signal
		print "aggerate finished"
		with  open("distinct_isp.csv",'r') as fid:#read isp file
			isp_list = fid.read().strip().split('\n')
		signals = []
		count = 0
		for isp in isp_list:
			if isp =="":
				continue
			isp = isp.replace("''", "'")
			if isp2signal.has_key(isp):
				signals.append(isp2signal[isp])
			else:
				#print isp
				count += 1
				signals.append(np.ones(dim) * -1)#mark missing data
		print "miss data" , count , len(isp_list)
		print product, "success"
		sio.savemat(product+"_random2_aggerate_signal", {'signals': signals,'isp': isp_list })
#fastrun()
main()
